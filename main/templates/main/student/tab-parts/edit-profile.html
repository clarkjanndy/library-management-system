{% load static %}


<form enctype="multipart/form-data" id="edit-student" method="POST" action="/students/{{student.user.id_no}}/edit">
    {% csrf_token %}

    <div class="row mb-2 form-group text-theme">
        <div class="col-xl-3 col-lg-3 col-md-5">
            <label>Profile Picture</label>
        </div>
        <div class="col-xl-9 col-lg-9 col-md-7">
            <img width="100" class="mb-2" id="preview" src="{% get_media_prefix %}{{student.user.photo}}">

            <div>
                <input type="file" id="photo" name="photo" accept="image/*" hidden>
                <label for="photo" class="btn btn-theme"><span class="bx bx-upload"></span></label>
                <button type="button" class="btn btn-theme" data-bs-toggle="modal" data-bs-target="#photoModal" id="accesscamera">
                    <span class="bx bx-camera"></span>
                </button>
            </div>
           
        </div>
    </div>

    <div class="row mb-2 form-group text-theme d-none">
        <div class="col-xl-3 col-lg-3 col-md-5">
            <label>First Name</label>
        </div>
        <div class="col-xl-9 col-lg-9 col-md-7">
            <input type="text" id="first_name" name="first_name" class="form-control" placeholder="First Name"
                value="{{student.user.first_name}}">
        </div>
        <div class="is-invalid"></div>
    </div>

    <div class="row mb-2 form-group text-theme d-none">
        <div class="col-xl-3 col-lg-3 col-md-5">
            <label>Middle Name</label>
        </div>
        <div class="col-xl-9 col-lg-9 col-md-7">
            <input type="text" id="middle_name" name="middle_name" class="form-control" placeholder="Middle Name"
                value="{{student.user.middle_name}}">
        </div>
        <div class="is-invalid"></div>
    </div>

    <div class="row mb-2 form-group text-theme d-none">
        <div class="col-xl-3 col-lg-3 col-md-5">
            <label>Last Name</label>
        </div>
        <div class="col-xl-9 col-lg-9 col-md-7">
            <input type="text" id="last_name" name="last_name" class="form-control" placeholder="Last Name"
                value="{{student.user.last_name}}">
        </div>
        <div class="is-invalid"></div>
    </div>

    <div class="row mb-2 form-group text-theme d-none">
        <div class="col-xl-3 col-lg-3 col-md-5">
            <label>Ext. Name</label>
        </div>
        <div class="col-xl-9 col-lg-9 col-md-7">
            <input type="text" id="ext_name" name="ext_name" class="form-control" placeholder="Extension Name"
                value="{{student.user.ext_name}}">
        </div>
        <div class="is-invalid"></div>
    </div>

    <div class="row mb-2 form-group text-theme">
        <div class="col-xl-3 col-lg-3 col-md-5">
            <label>Sex</label>
        </div>
        <div class="col-xl-9 col-lg-9 col-md-7">
            <select id="gender" name="gender" class="form-select">
                <option value="">--select--</option>
                <option value="male" {%if student.user.gender == 'male' %}selected{% endif %}>Male</option>
                <option value="female" {%if student.user.gender == 'female' %}selected{% endif %}>Female</option>
            </select>
        </div>
        <div class="is-invalid"></div>
    </div>

    <div class="row mb-2 form-group text-theme">
        <div class="col-xl-3 col-lg-3 col-md-5">
            <label>Civil Status</label>
        </div>
        <div class="col-xl-9 col-lg-9 col-md-7">
            <select id="civil_status" name="civil_status" class="form-select">
                <option value="">--select--</option>
                <option value="single" {%if student.user.civil_status == 'single' %}selected{% endif %}>Single</option>
                <option value="married" {%if student.user.civil_status == 'married' %}selected{% endif %}>Married</option>
                <option value="widowed" {%if student.user.civil_status == 'widowed' %}selected{% endif %}>Widowed</option>
            </select>
        </div>
        <div class="is-invalid"></div>
    </div>

    <div class="row mb-2 form-group text-theme">
        <div class="col-xl-3 col-lg-3 col-md-5">
            <label>Address</label>
        </div>
        <div class="col-xl-9 col-lg-9 col-md-7">
            <input type="text" id="address" name="address" class="form-control" placeholder="Address"
                value="{{student.user.address}}">
        </div>
        <div class="is-invalid"></div>
    </div>

    <div class="row mb-2 form-group text-theme">
        <div class="col-xl-3 col-lg-3 col-md-5">
            <label>Contact No.</label>
        </div>
        <div class="col-xl-9 col-lg-9 col-md-7">
            <input type="text" id="contact_no" name="contact_no" class="form-control" placeholder="Contact No."
                value="{{student.user.contact_no}}">
        </div>
        <div class="is-invalid"></div>
    </div>

    <div class="row mb-2 form-group text-theme">
        <div class="col-xl-3 col-lg-3 col-md-5">
            <label>Course</label>
        </div>
        <div class="col-xl-9 col-lg-9 col-md-7">
            <select id="course" name="course" class="form-select">
                <option value="">--select--</option>
                <option value="Bachelor of Science in Information Technology" {%if student.course == 'Bachelor of Science in Information Technology' %}selected{% endif %}>Bachelor of Science in Information Technology</option>
                <option value="Bachelor of Science in Hospitality Management"  {%if student.course == 'Bachelor of Science in Hospitality Management' %}selected{% endif %}>Bachelor of Science in Hospitality Management</option>
                <option value="Bachelor of Science in Criminology"  {%if student.course == 'Bachelor of Science in Criminology' %}selected{% endif %}>Bachelor of Science in Criminology</option>
                <option value="Bachelor of Secondary Education"  {%if student.course == 'Bachelor of Secondary Education' %}selected{% endif %}>Bachelor of Secondary Education</option>
                <option value="Bachelor of Elementary Education"  {%if student.course == 'Bachelor of Elementary Education' %}selected{% endif %}>Bachelor of Elementary Education</option>
            </select>
        </div>
        <div class="is-invalid"></div>
    </div>

    <div class="row mb-2 form-group text-theme">
        <div class="col-xl-3 col-lg-3 col-md-5">
            <label>Year</label>
        </div>
        <div class="col-xl-9 col-lg-9 col-md-7">
            <select id="year" name="year" class="form-select">
                <option value="">--select--</option>
                <option value="1" {%if student.year == '1' %}selected{% endif %}>I</option>
                <option value="2" {%if student.year == '2' %}selected{% endif %}>II</option>
                <option value="3" {%if student.year == '3' %}selected{% endif %}>III</option>
                <option value="4" {%if student.year == '4' %}selected{% endif %}>IV</option>
            </select>
        </div>
        <div class="is-invalid"></div>
    </div>

    <div class="row mb-2 form-group text-theme">
        <div class="col-xl-3 col-lg-3 col-md-5">
            <label>Section</label>
        </div>
        <div class="col-xl-9 col-lg-9 col-md-7">
            <input type="text" id="section" name="section" class="form-control" placeholder="Section"
                value="{{student.section}}">
        </div>
        <div class="is-invalid"></div>
    </div>

    <div class="d-flex justify-content-end">
        <button type="submit" class="btn btn-theme">Save Changes</button>
    </div>
</form>

<div class="modal fade" id="photoModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="exampleModalLabel">Capture Photo</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div>
            <div id="my_camera" class="d-block mx-auto rounded overflow-hidden"></div>
        </div>
        <div id="results" class="d-none"></div>
        <form method="post" id="photoForm">
            <input type="hidden" id="photoStore" name="photoStore" value="">
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-theme mx-auto text-white" id="takephoto">Capture Photo</button>
        <button type="button" class="btn btn-theme mx-auto text-white d-none" id="retakephoto">Retake</button>
        <button type="submit" class="btn btn-theme mx-auto text-white d-none" id="uploadphoto" form="photoForm">Upload</button>
      </div>
    </div>
  </div>
</div>

<script src="{% static 'js/sweetalert.js' %}"></script>
<script src="{% static 'js/webcam.min.js' %}"></script>
<!-- <script src="{% static 'js/uploadphoto.js' %}"></script> -->

<script>
    $(document).ready(function() {
    Webcam.set({
        width: 320,
        height: 240,
        image_format: 'jpeg',
        jpeg_quality: 90
    });

    $('#accesscamera').on('click', function() {
        Webcam.reset();
        Webcam.on('error', function() {
            $('#photoModal').modal('hide');
            swal({
                title: 'Warning',
                text: 'Please give permission to access your webcam',
                icon: 'warning'
            });
        });
        Webcam.attach('#my_camera');
    });

    $('#takephoto').on('click', take_snapshot);

    $('#retakephoto').on('click', function() {
        $('#my_camera').addClass('d-block');
        $('#my_camera').removeClass('d-none');

        $('#results').addClass('d-none');

        $('#takephoto').addClass('d-block');
        $('#takephoto').removeClass('d-none');

        $('#retakephoto').addClass('d-none');
        $('#retakephoto').removeClass('d-block');

        $('#uploadphoto').addClass('d-none');
        $('#uploadphoto').removeClass('d-block');
    });

    $('#photoForm').on('submit', function(e) {
        e.preventDefault();
        var formData = new FormData(this);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        $.ajax({
            url: '/students/{{student.user.id_no}}/upload-photo',
            type: 'POST',
            data: formData,
            contentType: false,
            processData: false,
            success: function(data) {
                if(data == 'success') {
                    Webcam.reset();

                    $('#my_camera').addClass('d-block');
                    $('#my_camera').removeClass('d-none');

                    $('#results').addClass('d-none');

                    $('#takephoto').addClass('d-block');
                    $('#takephoto').removeClass('d-none');

                    $('#retakephoto').addClass('d-none');
                    $('#retakephoto').removeClass('d-block');

                    $('#uploadphoto').addClass('d-none');
                    $('#uploadphoto').removeClass('d-block');

                    $('#photoModal').modal('hide');

                    window.location.reload();
                    // swal({
                    //     title: 'Success',
                    //     text: 'Photo uploaded successfully',
                    //     icon: 'success',
                    //     buttons: false,
                    //     closeOnClickOutside: false,
                    //     closeOnEsc: false,
                    //     timer: 2000
                    // })
                }
                else {
                    // swal({
                    //     title: 'Error',
                    //     text: 'Something went wrong',
                    //     icon: 'error'
                    // })
                }
            }
        })
    })
})

function take_snapshot()
{
    //take snapshot and get image data
    Webcam.snap(function(data_uri) {
        //display result image
        $('#results').html('<img src="' + data_uri + '" class="d-block mx-auto rounded"/>');

        var raw_image_data = data_uri.replace(/^data\:image\/\w+\;base64\,/, '');
        $('#photoStore').val(raw_image_data);
    });

    $('#my_camera').removeClass('d-block');
    $('#my_camera').addClass('d-none');

    $('#results').removeClass('d-none');

    $('#takephoto').removeClass('d-block');
    $('#takephoto').addClass('d-none');

    $('#retakephoto').removeClass('d-none');
    $('#retakephoto').addClass('d-block');

    $('#uploadphoto').removeClass('d-none');
    $('#uploadphoto').addClass('d-block');
}
</script>

<script>
    photo.onchange = evt => {
        const [file] = photo.files
        if (file) {
            preview.src = URL.createObjectURL(file)
        }
    }
</script>


<script>
    const validation = new window.JustValidate('#edit-student', {
        errorFieldCssClass: 'is-invalid',
    });

    validation
        .addField('#photo', [{
            rule: 'required',
            errorMessage: 'This field is required',
        },])
        .addField('#first_name', [{
            rule: 'required',
            errorMessage: 'This field is required',
        },])
        .addField('#last_name', [{
            rule: 'required',
            errorMessage: 'This field is required',
        },])
        .addField('#gender', [{
            rule: 'required',
            errorMessage: 'This field is required',
        },])
        .addField('#civil_status', [{
            rule: 'required',
            errorMessage: 'This field is required',
        },])
        .addField('#address', [{
            rule: 'required',
            errorMessage: 'This field is required',
        },])
        .addField('#contact_no', [{
            rule: 'required',
            errorMessage: 'This field is required',
        }, {
            rule: 'minLength',
            value: 11,
            errorMessage: 'Minimum length og 11 numbers',
        }, {
            rule: 'maxLength',
            value: 11,
            errorMessage: 'Maximum length og 11 numbers only',
        }, {
            rule: 'number',
            errorMessage: 'Input a valid contact number',
        }])
        .addField('#course', [{
            rule: 'required',
            errorMessage: 'This field is required',
        },])
        .addField('#year', [{
            rule: 'required',
            errorMessage: 'This field is required',
        },])
        .addField('#section', [{
            rule: 'required',
            errorMessage: 'This field is required',
        },])
        .onSuccess((event) => {
            document.getElementById("edit-student").submit();
        });

</script>